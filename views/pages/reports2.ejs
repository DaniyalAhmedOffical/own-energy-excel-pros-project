<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>



  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Semi+Condensed:wght@500&display=swap" rel="stylesheet">
  <title>Reports</title>


  <style>
    @media screen and (max-width: 900px) {
      body {
        background-image: url('../lead\ input\ form.png');
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-position: center;
        background-size: cover;
        text-align: center;
      }

      table.table tr th,
      table.table tr td {
        word-wrap: break-word;
        max-width: 150px;
      }


      #container {
        display: grid;
        margin: 10px;
        grid-template-columns: 1fr;
        grid-template-rows: 0.2fr 0.1fr 1.2fr 1fr 1fr 1fr;

        grid-template-areas:
          "logo"
          "pgTitle"
          "main";

        height: 100vh;
      }

      #main {
        border-bottom-left-radius: 20px;
        border-bottom-right-radius: 20px;
        margin: 0;
        padding: 0;
      }

      #pgTitle {
        grid-area: pgTitle;
        background: #1c617b;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        text-align: center;
      }

      #navBar {
        display: none;
      }

      div {
        background: #131F28;
        box-shadow: 0 0 15px 1px rgba(0, 0, 0, 0.4);
      }

      #searchDiv {
        padding: 6px;
      }

      #addbtn {
        display: block;
        margin-top: 4px;
        width: 100%;
        /* height: 34px;
            line-height: 20px; */
      }

      .row {
        margin: 10px;
        max-width: 100%;
      }

    }

    @media screen and (min-width: 900px) {
      body {
        background-image: url('../bgDesktop.png');
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-position: center;
        background-size: cover;

      }

      table.table td a {
        display: inline-block;
      }

      #logo {
        margin-left: 8%;
      }

      #container {
        display: grid;
        grid-template-columns: 0.6fr 1fr 1fr;
        grid-template-rows: 0.2fr 4fr;

        grid-template-areas:
          "logo logo pgTitle"
          "navBar main main";
        grid-gap: 0.4rem;
        height: 100vh;
        border-top-left-radius: 20px;
      }

      #main {
        border-top-left-radius: 20px;
      }


      #pgTitle {
        margin-top: 10px;
        font-size: x-large;

      }

      #navBar {
        background: #131F28;
        border-top-right-radius: 20px;
      }

      .nav-button {
        background: #1c617b;
        ;
        margin-top: 5px;
        border-bottom-right-radius: 20px;
        border-top-right-radius: 20px;
        font-weight: bold;
      }

      #addbtn {
        display: inline-block;
        width: 25%;
        height: 34px;
        line-height: 20px;
        margin-bottom: 15px;
      }

      #searchDiv {
        display: flex;
        line-height: 100px;
        padding-bottom: 0;
      }

      #table-div {
        padding: 6px;
      }

      div {
        padding: 20px 30px;
      }
    }


    div {
      border: 0 none;
      color: #fff;
    }

    #logo {
      grid-area: logo;
    }

    #pgTitle {
      padding: 20px 30px;
      background: #1c617b;
      grid-area: pgTitle;
    }

    #navBar {
      grid-area: navBar;
      padding-left: 0px;
    }

    #main {
      grid-area: main;
      background: #131F28;
      text-align: left;

      box-shadow: 0 0 15px 1px rgba(0, 0, 0, 0.4);
    }

    #leadsBx {
      grid-area: leadsBx;
    }

    #projectsBx {
      grid-area: projectsBx;
    }

    #payrollBx {
      grid-area: payrollBx;
    }

    a:link {
      text-decoration: none;
    }

    a:visited {
      text-decoration: none;
    }

    a:hover {
      text-decoration: none;
    }

    a:active {
      text-decoration: none;
    }
  </style>

  <style>
    .table-wrapper {
      background: #fff;
      padding: 20px 25px;
      margin: 30px 0;
      border-radius: 3px;
      box-shadow: 0 1px 1px rgba(0, 0, 0, .05);
    }

    .table-title {
      padding-bottom: 15px;
      background: #435d7d;
      color: #fff;
      padding: 16px 30px;
      margin: -20px -25px 10px;
      border-radius: 3px 3px 0 0;
    }

    .table-title h2 {
      margin: 5px 0 0;
      font-size: 24px;
    }

    .table-title .btn-group {
      float: right;
    }

    .table-title .btn {
      color: #fff;
      float: right;
      font-size: 13px;
      border: none;
      min-width: 50px;
      border-radius: 2px;
      border: none;
      outline: none !important;
      margin-left: 10px;
    }

    .table-title .btn i {
      float: left;
      font-size: 21px;
      margin-right: 5px;
    }

    .table-title .btn span {
      float: left;
      margin-top: 2px;
    }

    table.table tr th,
    table.table tr td {
      /* border-color: #e9e9e9; */
      padding: 12px 15px;
      vertical-align: middle;
    }

    table.table tr th,
    table.table tr td {
      /* border-color: #e9e9e9; */
      padding: 12px 15px;
      vertical-align: middle;
    }



    table.table tr th:last-child {
      width: 100px;
    }

    table.table-striped tbody tr:nth-of-type(odd) {
      background-color: #fcfcfc;
    }

    table.table-striped.table-hover tbody tr:hover {
      background: #f5f5f5;
    }

    table.table th i {
      font-size: 13px;
      margin: 0 5px;
      cursor: pointer;
    }

    table.table td:last-child i {
      opacity: 0.9;
      font-size: 22px;
      margin: 0 5px;
    }

    table.table td a {
      font-weight: bold;
      color: #566787;
      text-decoration: none;
      outline: none !important;
    }

    table.table td a:hover {
      color: #2196F3;
    }

    table.table td a.edit {
      color: #FFC107;
    }

    table.table td a.delete {
      color: #F44336;
    }

    table.table td i {
      font-size: 19px;
    }

    table.table .avatar {
      border-radius: 50%;
      vertical-align: middle;
      margin-right: 10px;
    }

    .pagination {
      float: right;
      margin: 0 0 5px;
    }

    .pagination li a {
      border: none;
      font-size: 13px;
      min-width: 30px;
      min-height: 30px;
      color: #999;
      margin: 0 2px;
      line-height: 30px;
      border-radius: 2px !important;
      text-align: center;
      padding: 0 6px;
    }

    .pagination li a:hover {
      color: #666;
    }

    .pagination li.active a,
    .pagination li.active a.page-link {
      background: #03A9F4;
    }

    .pagination li.active a:hover {
      background: #0397d6;
    }

    .pagination li.disabled i {
      color: #ccc;
    }

    .pagination li i {
      font-size: 16px;
      padding-top: 6px
    }

    .hint-text {
      float: left;
      margin-top: 10px;
      font-size: 13px;
    }

    /* Custom checkbox */
    .custom-checkbox {
      position: relative;
    }

    .custom-checkbox input[type="checkbox"] {
      opacity: 0;
      position: absolute;
      margin: 5px 0 0 3px;
      z-index: 9;
    }

    .custom-checkbox label:before {
      width: 18px;
      height: 18px;
    }

    .custom-checkbox label:before {
      content: '';
      margin-right: 10px;
      display: inline-block;
      vertical-align: text-top;
      background: white;
      border: 1px solid #bbb;
      border-radius: 2px;
      box-sizing: border-box;
      z-index: 2;
    }

    .custom-checkbox input[type="checkbox"]:checked+label:after {
      content: '';
      position: absolute;
      left: 6px;
      top: 3px;
      width: 6px;
      height: 11px;
      border: solid #000;
      border-width: 0 3px 3px 0;
      transform: inherit;
      z-index: 3;
      transform: rotateZ(45deg);
    }

    .custom-checkbox input[type="checkbox"]:checked+label:before {
      border-color: #03A9F4;
      background: #03A9F4;
    }

    .custom-checkbox input[type="checkbox"]:checked+label:after {
      border-color: #fff;
    }

    .custom-checkbox input[type="checkbox"]:disabled+label:before {
      color: #b8b8b8;
      cursor: auto;
      box-shadow: none;
      background: #ddd;
    }


    /* Modal styles */

    .modal {
      color: #000;
    }

    .modal .modal-dialog {
      /* max-width: 400px; */
      width: 100%;
      height: 100%;
    }

    .modal .modal-header,
    .modal .modal-body,
    .modal .modal-footer {
      padding: 20px 30px;
    }

    .modal .modal-content {
      border-radius: 3px;
    }

    .modal .modal-footer {
      background: #ecf0f1;
      border-radius: 0 0 3px 3px;
    }

    .modal .modal-title {
      display: inline-block;
    }

    .modal .form-control {
      border-radius: 2px;
      box-shadow: none;
      border-color: #dddddd;
    }

    .modal textarea.form-control {
      resize: vertical;
    }

    .modal .btn {
      border-radius: 2px;
      min-width: 100px;
    }

    .modal form label {
      font-weight: normal;
    }

    .location {
      /* text-indent: 25px; */
      font-size: small;
    }
  </style>

  <style>
    .table th {
      background-color: #1c617b;
      color: #fff;
    }

    .table tr:hover {
      background-color: #1c617b;
      color: #fff;
    }
  </style>

  <style>
    h3,
    h6 {
      margin: 0;
      line-height: 1em;
    }

    h3 {
      margin-bottom: 1em;
    }

    h6,
    .name {
      font-size: .8em;
      padding: 0 0 .5em;
      color: #919191;
    }

    figure {
      margin: 0 auto;
      max-width: 1100px;
      position: relative;
    }

    .graphic {
      /* padding-left: 30px; */
    }

    .row {
      margin-bottom: 1.5em;
    }

    @keyframes expand {
      from {
        width: 0%;
      }

      to {
        width: 100%;
      }
    }

    @media screen and (min-width: 768px) {
      @keyframes expand {
        from {
          width: 0%;
        }

        to {
          width: calc(100% - 75px);
        }
      }
    }

    .chart {
      overflow: hidden;
      width: 0%;
      animation: expand 1.5s ease forwards;
    }

    .row+.row .chart {
      animation-delay: .2s;
    }

    .row+.row+.row .chart {
      animation-delay: .4s;
    }

    .block {
      display: block;
      height: 100px;
      color: #fff;
      font-size: .75em;
      float: left;
      background-color: #334D5C;
      position: relative;
      overflow: hidden;
      opacity: 1;
      transition: opacity, .3s ease;
      cursor: pointer;
    }

    .block:nth-of-type(2),
    .legend li:nth-of-type(2):before {
      background-color: #45B29D;
    }

    .block:nth-of-type(3),
    .legend li:nth-of-type(3):before {
      background-color: #EFC94C;
    }

    .block:nth-of-type(4),
    .legend li:nth-of-type(4):before {
      background-color: #E27A3F;
    }

    .block:nth-of-type(5),
    .legend li:nth-of-type(5):before {
      background-color: #DF5A49;
    }

    .block:nth-of-type(6),
    .legend li:nth-of-type(6):before {
      background-color: #962D3E;
    }

    .block:nth-of-type(7),
    .legend li:nth-of-type(7):before {
      background-color: #6E1ADB;
    }

    .block:nth-of-type(8),
    .legend li:nth-of-type(8):before {
      background-color: #299BF2;
    }

    .block:hover {
      opacity: .65;
    }

    .value {
      display: block;
      line-height: 1em;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%);
    }

    .x-axis {
      text-align: center;
      padding: .5em 0 2em;
    }

    .y-axis {
      height: 20px;
      transform: translate(-32px, 170px) rotate(270deg);
      position: absolute;
      left: 0;
    }

    .legend {
      margin: 0 auto;
      padding: 0;
      font-size: .9em;
    }

    .legend li {
      display: inline-block;
      padding: .25em 1em;
      line-height: 1em;
    }

    .legend li:before {
      content: "";
      margin-right: .5em;
      display: inline-block;
      width: 8px;
      height: 8px;
      background-color: #334D5C;
    }

    @media screen and (min-width: 768px) {
      h6 {
        padding: 0;
        width: 75px;
        float: left;
        line-height: 100px;
      }

      .name {
        padding: 0;
        width: 75px;
        float: left;
        margin-right: 50px;
      }

      .block {
        font-size: 1em;
      }

    
      .legend {
        width: 50%;
      }


    }
  </style>



</head>

<body onload="getReportData()">

  <main id="container" class="main">
    <a id="logo" href="../">
      <img class="top-image" src="../own+menu+logo-removebg-preview.png"
        style="line-height: 1;width: 250px; margin: 10px; text-align:center;" alt="Own Energy">
    </a>
    <div id="pgTitle">REPORTS</div>
    <div id="navBar" class="">

      <a href="../views/leads" id="list">
        <div class="nav-button">LEADS</div>
      </a>
      <a href="../views/leads" id="project">
        <div class="nav-button">PROJECTS</div>
      </a>

      <% if (data.admin) {%>
        <a href="../payments" id="payment">
          <div class="nav-button">PAYMENTS</div>
        </a>
        <a href="../expenses" id="expenses">
          <div class="nav-button">EXPENSES</div>
        </a>
        <% } %>

          <% if (data.manager) {%>
            <a href="../views/users" id="users">
              <div class="nav-button">USERS</div>
            </a>
            <% } %>
    </div>

    <div id="main">
      <figure>

        <div class="graphic">

        </div>

        <div class="x-axis">
          <h3>Lead Status</h3>
          <ul id="legend" class="legend">

          </ul>
        </div>

      </figure>

    </div>


    </div>

  </main>


  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js'></script>
  <script>
    $('.value').each(function () {
      var text = $(this).text();
      $(this).parent().css('width', text);
    });

    $('.block').tooltip();
  </script>

  <script>
    function getReportData() {
      $.ajax({
        url: "/reportData",
        type: "get",
        dataType: 'json',

        success: function (data, status, xhr) {
          console.log(data);
          // setting up legend
          const allApptOutcomes = data.allApptOutcomes;
          allApptOutcomes.forEach(apptOutcome => {
            const legend = document.getElementById('legend');
            const newListItem = document.createElement('li');
            newListItem.appendChild(document.createTextNode(apptOutcome.name));
            legend.appendChild(newListItem);
          })

          const usersAndLeads = data.usersAndLeads;
          usersAndLeads.forEach(userAndLead => {
            var rowDiv = document.createElement('div');
            rowDiv.setAttribute('class', 'row');

            // var nameSpan = document.createElement('span');
            // nameSpan.setAttribute('class', 'name');
            // nameSpan.innerHTML = userAndLead.name

            // rowDiv.appendChild(nameSpan)

            var chartDiv = document.createElement('span');
            chartDiv.setAttribute('class', 'chart');

            var nameP = document.createElement('p');
            nameP.setAttribute('class', 'name');
            nameP.innerHTML = userAndLead.name
            chartDiv.appendChild(nameP)

            allApptOutcomes.forEach(apptOutcome => {

              var count = countStatusOccurrences(userAndLead.leads, apptOutcome.id);
              

              var parentSpan = document.createElement('span');
              parentSpan.setAttribute('class', 'block');
              parentSpan.setAttribute('title', apptOutcome.name);

              var childSpan = document.createElement('span');
              childSpan.setAttribute('class', 'value');
              childSpan.innerHTML = count;

              parentSpan.style.width = count  + 'em'
              parentSpan.appendChild(childSpan);
              chartDiv.appendChild(parentSpan);
            })

            rowDiv.appendChild(chartDiv)
            $('.graphic').append(rowDiv)
            console.log('added')
          })

        },
        error: function (jqXhr, textStatus, errorMessage) {
          console.log(errorMessage);
        }
      });
    }

    function countStatusOccurrences(leadsArray, statusIdToMatch) {

      const matchingLeads = leadsArray.filter(lead => {
        return lead.status === statusIdToMatch;
      });

      return matchingLeads.length;
    }
  </script>


</body>

</html>